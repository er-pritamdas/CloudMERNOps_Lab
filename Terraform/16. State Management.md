# 📘 Terraform State Management – Notes

---

## 🔹 What is Terraform State?

* **State file (`terraform.tfstate`)** stores the mapping between your Terraform code and real-world infrastructure.
* Without it → Terraform won’t know what resources exist.
* Acts as Terraform’s **“memory.”**

---

## 🔹 Why is State Important?

1. Tracks **real infra resource IDs** (like `i-123456` for EC2).
2. Enables **plan & apply** by comparing  **code vs state vs real infra** .
3. Allows **team collaboration** with remote state.

---

## 🔹 Types of State

1. **Local State** (default)
   * Stored in `terraform.tfstate` locally.
   * Not good for teams.
2. **Remote State**
   * Stored in S3, GCS, Terraform Cloud, etc.
   * Supports  **locking, encryption, versioning, sharing** .

---

## 🔹 State Locking

* Prevents **parallel changes** to the same state file.
* Example: In AWS, use **S3 backend + DynamoDB** for locking.
* Error if someone else is applying:

  *“Error acquiring the state lock”*

---

## 🔹 Drift

* **Drift = real infra ≠ Terraform state.**
* Happens when changes are made **outside Terraform** (e.g., AWS console).
* Fix: `terraform plan` detects → `terraform apply` reconciles infra with code.
* **Code (`main.tf`) is always the source of truth.**

---

## 🔹 Important Commands

<pre class="overflow-visible!" data-start="1425" data-end="1870"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><span class="" data-state="closed"></span></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>terraform state list              </span><span># list resources in state</span><span>
terraform state show <resource>   </span><span># show details</span><span>
terraform state </span><span>rm</span><span> <resource>     </span><span># remove from state (infra not destroyed)</span><span>
terraform state </span><span>mv</span><span> <old> <new>    </span><span># move resource in state</span><span>
terraform import <res> <</span><span>id</span><span>>       </span><span># import existing infra into state</span><span>
terraform refresh                 </span><span># sync state with real infra (legacy)</span><span>
terraform plan                    </span><span># detect drift</span><span>
</span></span></code></div></div></pre>

---

## 🔹 Importing Resources

* Bring existing infra under Terraform management.

<pre class="overflow-visible!" data-start="1956" data-end="2012"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><span class="" data-state="closed"></span></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>terraform import aws_instance.web i-0abc1234
</span></span></code></div></div></pre>

---

## 🔹 Remote State & Data Sharing

* Share infra outputs between projects.

<pre class="overflow-visible!" data-start="2095" data-end="2391"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"><span class="" data-state="closed"></span></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-hcl"><span>data "terraform_remote_state" "network" {
  backend = "s3"
  config = {
    bucket = "pritam-terraform-state"
    key    = "network/terraform.tfstate"
    region = "ap-south-1"
  }
}

resource "aws_instance" "web" {
  subnet_id = data.terraform_remote_state.network.outputs.subnet_id
}
</span></code></div></div></pre>

---

## 🔹 Security of State

* State may contain  **secrets (passwords, keys)** .
* Always:
  * Encrypt state (e.g., S3 + KMS).
  * Restrict access with IAM.
  * Use Terraform Cloud/Vault for sensitive data.

---

## 🔹 Best Practices

1. Always use **remote state** in teams.
2. Enable  **locking + versioning** .
3. Never edit state manually.
4. Keep code updated → avoid drift.
5. Split states for large projects (network, compute, DB).
6. Use `terraform import` instead of recreating existing infra.

---

# 🎯 Interview Tips

* **Q:** What is Terraform state & why is it needed?

  ✅ State is a file mapping resources between code & real infra. Terraform needs it to know what exists and what to change.
* **Q:** How do you handle drift?

  ✅ Run `terraform plan` → detect drift → `terraform apply` → fix. Code is the source of truth.
* **Q:** Difference between local and remote state?

  ✅ Local = only on your machine. Remote = centralized, supports collaboration, locking, and security.
* **Q:** How do you secure Terraform state?

  ✅ Encrypt, restrict access, use Terraform Cloud or S3 + KMS + DynamoDB.
* **Q:** Have you used `terraform import`?

  ✅ Yes, to bring existing resources into Terraform state without recreating.
